apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: promote-to-prod
  annotations:
    pipelinesascode.tekton.dev/on-cel-expression: |
      event == "push" && body.object_kind == "release"
    pipelinesascode.tekton.dev/pipeline: "https://${{values.gitlabHost}}/rhdh/tssc-sample-pipelines/-/raw/main/pac/pipelines/promote-to-env.yaml"
    pipelinesascode.tekton.dev/task-1: "https://${{values.gitlabHost}}/rhdh/tssc-sample-pipelines/-/raw/main/pac/tasks/gather-images-to-verify.yaml"
    pipelinesascode.tekton.dev/task-2: "https://${{values.gitlabHost}}/rhdh/tssc-sample-pipelines/-/raw/main/pac/tasks/verify-enterprise-contract.yaml"
    pipelinesascode.tekton.dev/task-3: "https://${{values.gitlabHost}}/rhdh/tssc-sample-pipelines/-/raw/main/pac/tasks/skopeo-copy.yaml"
    pipelinesascode.tekton.dev/task-4: "https://${{values.gitlabHost}}/rhdh/tssc-sample-pipelines/-/raw/main/pac/tasks/update-deployment.yaml"
  labels:
    backstage.io/kubernetes-id: "${{values.name}}"
spec:
  params:
  - name: git-url
    value: '{{repo_url}}'
  - name: revision
    value: '{{body.ref}}'
  - name: target-branch
    value: 'prod-{{body.ref}}'
  - name: source-image
    value: '${{values.quayHost}}/tssc/${{values.name}}'
  - name: source-image-tag
    value: '{{body.ref}}'
  - name: environment
    value: prod
  pipelineRef:
    name: promote-to-env
  workspaces:
    - name: workspace
      volumeClaimTemplate:
        spec:
          accessModes:
          - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
    - name: gitops-auth
      secret:
        secretName: "{{ git_auth_secret }}"
